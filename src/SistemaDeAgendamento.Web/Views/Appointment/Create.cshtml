@model SistemaDeAgendamento.Web.Models.Appointment.CreateViewModel;

@{
    ViewData["Title"] = "Novo Agendamento";
    var serviceDuration = Model.Service!.Duration;
}


<div class="d-flex align-items-center mb-4">
    <a href="@Url.Action("Read", "Service")" class="btn btn-outline-secondary btn-sm me-2">
        <i class="bi bi-arrow-left"></i>
    </a>
    <div>
        <h1 class="h3 fw-bold mb-1">
            <i class="bi bi-calendar-plus text-primary me-2"></i>Novo Agendamento
        </h1>
        <p class="text-muted mb-0">
            Serviço escolhido: <strong class="text-primary">@Model.Service.Name</strong>
        </p>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <form class="row g-4 needs-validation" asp-controller="Appointment" asp-action="Create" id="form" novalidate>
            <input asp-for="Service.Id" type="hidden" required />
            <input id="serviceDuration" asp-for="Service.Duration" type="hidden" required />

            <div class="col-12">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-person-circle text-primary me-2"></i>Informações do Cliente
                </h5>
            </div>

            <div class="col-md-12">
                <label for="inputName" class="form-label fw-semibold">
                    <i class="bi bi-person me-1 text-primary"></i>Nome Completo
                </label>
                <input type="text" class="form-control form-control-lg" id="inputName"
                       asp-for="Client.Name" placeholder="Digite seu nome completo" required>
            </div>

            <div class="col-md-6">
                <label for="inputPhoneNumber" class="form-label fw-semibold">
                    <i class="bi bi-whatsapp me-1 text-success"></i>Telefone (WhatsApp)
                </label>
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-light">
                        <i class="bi bi-telephone text-muted"></i>
                    </span>
                    <input type="text" class="form-control" id="inputPhoneNumber"
                           asp-for="Client.PhoneNumber" placeholder="(61) 9 9999-9999" required>
                </div>
                @* <div class="invalid-feedback">
                    Digite um número de telefone válido com 11 dígitos.
                </div> *@
            </div>

            <div class="col-md-6">
                <label for="inputEmployee" class="form-label fw-semibold">
                    <i class="bi bi-person-badge me-1 text-info"></i>Selecione o Profissional
                </label>
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-light">
                        <i class="bi bi-person-badge text-muted"></i>
                    </span>
                    <select class="form-select" id="inputEmployee" asp-items="Model.Employees" asp-for="EmployeeId" required>
                        <option value="">Selecione um profissional</option>
                    </select>
                </div>
            </div>

            <div class="col-12 mt-3">
                <hr class="my-4">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-calendar3 text-primary me-2"></i>Selecione Data e Horário
                </h5>
            </div>

            <div class="col-12">
                <div class="text-center mb-3">
                    <div class="month fw-semibold mb-3 text-primary" id="monthLabel" aria-hidden="true"></div>

                    <div class="d-flex align-items-center justify-content-center gap-2" role="group" aria-label="Selecionar dia">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevDays()" aria-label="Dias anteriores">
                            <i class="bi bi-arrow-left"></i>
                        </button>

                        <div id="daySelector" class="d-flex gap-2 flex-wrap justify-content-center" tabindex="0" role="listbox" aria-label="Dias disponíveis"></div>

                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="nextDays()" aria-label="Próximos dias">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>

                    <input asp-for="SelectedDate" type="hidden" id="dateInput" required>
                </div>
            </div>

            <input asp-for="SelectedTime" type="hidden" id="timeInput" />

            <div id="available-times" class="available-times schedule-grid mt-3"></div>

            @Html.ValidationSummary(false, "", new { @class = "text-danger" })

            <div class="col-12 pt-3 border-top">
                <div class="d-flex gap-2 justify-content-end">
                    <a class="btn btn-outline-secondary" href="@Url.Action("Read", "Service")">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#confirmationModal">
                        <i class="bi bi-check-circle me-1"></i>Confirmar Agendamento
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Confirmar Agendamento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <h4>Serviço</h4>
                <p>Serviço: <span id="modalServiceName">@Model.Service.Name</span></p>
                <p>Profissional: <span id="modalProfessional"></span></p>
                <p>Preço: <span id="modalPrice">@Model.Service.Price</span></p>
                <p>Data: <span id="modalDate"></span></p>
                <p>Horário de Início: <span id="modalStartTime"></span></p>

                <h4 class="mt-3">Cliente</h4>
                <p>Nome: <span id="modalClientName"></span></p>
                <p>Telefone: <span id="modalClientPhone"></span></p>

                <div id="modalAlert" class="text-danger small mt-2" style="display:none;">
                    preencha todas as informações antes de confirmar.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button id="modalSubmitBtn" type="submit" class="btn btn-primary">Agendar</button>
            </div>
        </div>
    </div>
</div>

<div id="limitToast" class="alert alert-info position-fixed bottom-0 end-0 m-3 fade" role="alert" style="z-index: -1;" aria-live="polite">
    Você chegou ao limite máximo de agendamento (3 meses à frente).
</div>
<div id="invalidInformations" class="alert alert-danger position-fixed bottom-0 end-0 m-3 fade" role="alert" style="z-index: -1;" aria-live="assertive">
    Preencha todas as informações corretamente
</div>

@section Scripts {
    <script>
        (() => {
            'use strict';

            const forms = document.querySelectorAll('.needs-validation');

            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {

                    const nameInput = document.getElementById('inputName');
                    const name = nameInput.value.trim();
                    const parts = name.split(/\s+/);
                    const isFullName = parts.length >= 2 && parts.every(p => p.length > 1);
                    const phoneInput = document.getElementById('inputPhoneNumber');
                    const phoneDigits = phoneInput.value.replace(/\D/g, '');
                    const isValidPhone = phoneDigits.length === 11;

                    if (!isValidPhone) {
                        phoneInput.classList.add('is-invalid');
                        event.preventDefault();
                        event.stopPropagation();
                        closeModal();
                    } else {
                        phoneInput.classList.remove('is-invalid');
                    }

                    if (!isFullName) {
                        nameInput.classList.add('is-invalid');
                        event.preventDefault();
                        event.stopPropagation();
                        closeModal();
                    } else {
                        nameInput.classList.remove('is-invalid');
                    }

                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        showInvalidInformationAlert();
                    }

                    form.classList.add('was-validated');
                }, false);
            });
        })();

        const phoneInput = document.getElementById('inputPhoneNumber');
        phoneInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);

            if (value.length > 2 && value.length <= 7) {
                value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
            } else if (value.length > 7 && value.length <= 11) {
                value = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}-${value.slice(7)}`;
            } else if (value.length > 0 && value.length <= 2) {
                value = `(${value}`;
            }

            e.target.value = value;
        });

        const form = document.querySelector('form');
        form.addEventListener('submit', function () {
            const input = document.getElementById('inputPhoneNumber');
            input.value = input.value.replace(/\D/g, '');
        });

        function parseISODateToLocal(iso) {
            if (!iso) return null;
            const parts = iso.split('-').map(Number);
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        async function fetchAvailableTimes() {
            const employeeSelect = document.getElementById("inputEmployee");
            const dateInput = document.getElementById("dateInput");
            const scheduleGrid = document.getElementById("available-times");
            const serviceDuration = document.getElementById("serviceDuration").value;

            const employeeId = employeeSelect.value;
            const date = dateInput.value;

            if (!employeeId) {
                scheduleGrid.innerHTML = "<p>Selecione um profissional.</p>"
                return;
            }

            if (!date) {
                scheduleGrid.innerHTML = "<p>Selecione uma data.</p>"
                return;
            }

            scheduleGrid.innerHTML = "<p>Carregando horários...</p>";

            try {
                const response = await fetch(`@Url.Action("GetAvailableTimes", "Appointment")?employeeId=${employeeId}&date=${date}&serviceDuration=${serviceDuration}`);
                if (!response.ok) throw new Error("Erro ao buscar horários");

                const times = await response.json();

                if (!times || times.length === 0) {
                    scheduleGrid.innerHTML = "<p>Nenhum horário disponível neste dia. Tente selecionar outro dia ou profissional</p>";
                    return;
                }

                const localDate = parseISODateToLocal(date);
                const now = new Date();

                let html = `
                    <div class="day-block text-center">
                        <h5 class="fw-semibold text-primary mb-3">Horarios disponiveis para o dia: ${localDate.toLocaleDateString('pt-BR')}</h5>
                        <label class="form-label h5 mb-3 text-center">Selecione o horario que deseja iniciar o seriviço</label>
                        <div class="d-flex flex-wrap justify-content-center">
                `;

                times.forEach(time => {
                    const [hours, minutes] = time.split(':').map(Number);
                    const [y, m, d] = date.split('-').map(Number);
                    const slotDate = new Date(y, m - 1, d, hours, minutes, 0, 0);

                    const isToday = new Date(y, m - 1, d).toDateString() === now.toDateString();
                    const hasPassed = isToday && slotDate < now;

                    html += `
                        <button type="button"
                            class="btn btn-outline-primary hour-btn ${hasPassed ? 'disabled' : ''}"
                            data-date="${date}"
                            data-time="${time}"
                            ${hasPassed ? 'disabled' : ''}>
                            ${time}
                        </button>`;
                });

                html += `</div></div>`;
                scheduleGrid.innerHTML = html;

                const hourButtons = document.querySelectorAll(".hour-btn");
                hourButtons.forEach(btn => {
                    btn.addEventListener("click", () => {
                        if (btn.classList.contains("disabled")) return;

                        hourButtons.forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");

                        const timeInput = document.getElementById('timeInput');
                        const time = btn.getAttribute('data-time') || '';

                        if (timeInput) timeInput.value = time ? `${time}:00` : '';
                    });
                });

            } catch (err) {
                console.error(err);
                scheduleGrid.innerHTML = "<p>Erro ao carregar horários.</p>";
            }
        }

        (function () {
            const confirmationModalEl = document.getElementById('confirmationModal');
            const modalSubmitBtn = document.getElementById('modalSubmitBtn');
            const modalAlert = document.getElementById('modalAlert');
            const timeInput = document.getElementById('timeInput');

            if (confirmationModalEl) {
                confirmationModalEl.addEventListener('show.bs.modal', function (event) {
                    const employeeSelect = document.getElementById('inputEmployee');
                    const professionalText = employeeSelect && employeeSelect.options.length > 0
                        ? employeeSelect.options[employeeSelect.selectedIndex].text
                        : '';
                    document.getElementById('modalProfessional').innerText = professionalText || '—';

                    const dateIso = document.getElementById('dateInput').value;
                    const selectedTime = document.querySelector('.hour-btn.active')?.getAttribute('data-time') || '';
                    document.getElementById('modalDate').innerText = dateIso ? parseISODateToLocal(dateIso).toLocaleDateString('pt-BR') : '—';
                    document.getElementById('modalStartTime').innerText = selectedTime || '—';

                    var clientName = document.getElementById('inputName').value || '—';
                    var clintPhoneNumber = document.getElementById('inputPhoneNumber').value || '—';
                    document.getElementById('modalClientName').innerText = clientName;
                    document.getElementById('modalClientPhone').innerText = clintPhoneNumber

                    timeInput.value = selectedTime || '';

                    if (!selectedTime) {
                        modalSubmitBtn.disabled = true;
                        modalAlert.style.display = 'block';
                    } else {
                        modalSubmitBtn.disabled = false;
                        modalAlert.style.display = 'none';
                    }
                });
            }
        })();

        let currentDayOffset = 0;
        let DAYS_PER_PAGE = window.innerWidth < 768 ? 4 : 7;
        const MAX_DAYS_AHEAD = 90;

        function updateMonthLabel(offset) {
            const monthContainer = document.querySelector(".month");
            const referenceDate = new Date();
            referenceDate.setDate(referenceDate.getDate() + offset);
            referenceDate.setHours(0, 0, 0, 0);
            const monthName = referenceDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            monthContainer.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        }

        function generateAvailableDays(daysToShow = DAYS_PER_PAGE, offset = 0) {
            const daySelector = document.getElementById('daySelector');
            if (!daySelector) return;

            const baseDate = new Date();
            baseDate.setHours(0, 0, 0, 0);
            baseDate.setDate(baseDate.getDate() + offset);

            let html = "";
            for (let i = 0; i < daysToShow; i++) {
                const date = new Date(baseDate);
                date.setDate(baseDate.getDate() + i);

                const isoDate = date.toLocaleDateString('en-CA');
                const label = date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit' });

                html += `
                    <button type="button" class="btn btn-outline-secondary mx-1" data-date="${isoDate}" role="option">
                        ${label}
                    </button>`;
            }

            daySelector.innerHTML = html;
            updateMonthLabel(offset);

            const buttons = daySelector.querySelectorAll("button");
            buttons.forEach(btn => {
                btn.addEventListener("click", () => {
                    buttons.forEach(b => {
                        b.classList.remove("btn-primary");
                        b.classList.add("btn-outline-secondary");
                        b.setAttribute("aria-selected", "false");
                    });
                    btn.classList.remove("btn-outline-secondary");
                    btn.classList.add("btn-primary");
                    btn.setAttribute("aria-selected", "true");

                    dateInput.value = btn.getAttribute("data-date");
                    fetchAvailableTimes();
                });
            });

            if (buttons.length > 0) {
                buttons[0].classList.remove("btn-outline-secondary");
                buttons[0].classList.add("btn-primary");
                buttons[0].setAttribute("aria-selected", "true");
                dateInput.value = buttons[0].getAttribute("data-date");
            }
        }

        function nextDays() {
            if (currentDayOffset + DAYS_PER_PAGE > MAX_DAYS_AHEAD) {
                showLimitToast();
                return;
            }
            currentDayOffset += DAYS_PER_PAGE;
            generateAvailableDays(DAYS_PER_PAGE, currentDayOffset);
        }

        function prevDays() {
            if (currentDayOffset === 0) return;
            currentDayOffset -= DAYS_PER_PAGE;
            generateAvailableDays(DAYS_PER_PAGE, currentDayOffset);
        }

        function showLimitToast() {
            const toast = document.getElementById("limitToast");
            toast.classList.add("show");
            toast.style.zIndex = "9999";
            setTimeout(() => {
                toast.classList.remove("show");
                toast.style.zIndex = "-1";
            }, 3000);
        }

        function showInvalidInformationAlert() {
            const InvalidInformationAlert = document.getElementById("invalidInformations");
            InvalidInformationAlert.classList.add("show");
            InvalidInformationAlert.style.zIndex = "9999";
            setTimeout(() => {
                InvalidInformationAlert.classList.remove("show");
                InvalidInformationAlert.style.zIndex = "-1";
            }, 5000);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const employeeSelect = document.getElementById("inputEmployee");
            const dateInput = document.getElementById("dateInput");

            generateAvailableDays(DAYS_PER_PAGE, 0);
            updateMonthLabel(0);

            employeeSelect.addEventListener("change", fetchAvailableTimes);
            dateInput.addEventListener("change", fetchAvailableTimes);

            window.addEventListener("resize", () => {
                const newDays = window.innerWidth < 768 ? 4 : 7;
                if (newDays !== DAYS_PER_PAGE) {
                    DAYS_PER_PAGE = newDays;
                    generateAvailableDays(DAYS_PER_PAGE, currentDayOffset);
                }
            });

            const daySelector = document.getElementById('daySelector');
            daySelector.addEventListener('keydown', (e) => {
                const active = daySelector.querySelector('[aria-selected="true"]');
                if (!active) return;
                if (e.key === 'ArrowLeft') {
                    const prev = active.previousElementSibling;
                    if (prev) prev.click();
                    else prevDays();
                } else if (e.key === 'ArrowRight') {
                    const next = active.nextElementSibling;
                    if (next) next.click();
                    else nextDays();
                }
            });
        });

        function closeModal(){
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmationModal'));
            modal.hide();
        }

    </script>
    <style>
        .hour-btn {
            min-width: 70px;
            margin: 0.25rem;
            font-size: 0.9rem;
        }

            .hour-btn.active {
                background-color: var(--primary) !important;
                color: #fff !important;
                border-color: var(--primary) !important;
            }

            .hour-btn.disabled,
            .hour-btn:disabled {
                pointer-events: none;
                opacity: 0.6;
            }
    </style>
}