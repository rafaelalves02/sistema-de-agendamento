@model SistemaDeAgendamento.Web.Models.Appointment.CreateViewModel;

@{
    ViewData["Title"] = "Novo Agendamento";
    var serviceDuration = Model.Service!.Duration;
}


<h1>Novo Agendamento</h1>
<h2 class="mt-3 mb-5 text-secondary">Serviço escolhido: <span class="text-primary">@Model.Service.Name</span></h2>

<form class="row g-3 needs-validation" asp-controller="Appointment" asp-action="Create" id="form" novalidate>

    <input asp-for="Service.Id" type="hidden" required/>
    <input id="serviceDuration" asp-for="Service.Duration" type="hidden" required />

    <div class="col-md-12">
        <label for="inputName" class="form-label">Nome Completo:</label>
        <input type="text" class="form-control" id="inputName" asp-for="Client.Name" placeholder="Seu Nome" required>
        <div class="invalid-feedback">
            Por Favor Digite seu nome completo.
        </div>
    </div>

    <div class="col-6">
        <label for="inputPhoneNumber" class="form-label">Telefone(Whatsapp):</label>
        <input type="text" class="form-control" id="inputPhoneNumber" asp-for="Client.PhoneNumber" placeholder="(61) 9 9999-9999" required>
        <div class="invalid-feedback">
            Digite um número de telefone válido com 11 dígitos.
        </div>  
    </div>

    <div class="col-6">
        <label for="inputEmployee" class="form-label">Selecione o profissional:</label>
        <select class="form-select" id="inputEmployee" asp-items="Model.Employees" asp-for="EmployeeId" required>
            <option>Clique aqui para selecionar um profissional</option>
        </select>
    </div>

    <div class="container-fluid mt-4 p-0">
        <div class="row justify-content-center">
            <div class="col-12 text-center">
                <label class="form-label h5 mb-3">Selecione um dia:</label>

                <div class="month fw-semibold mb-2" id="monthLabel" aria-hidden="true"></div>

                <div class="days align-items-center justify-content-center px-1 px-sm-3" role="group" aria-label="Selecionar dia">
                   
                    <button type="button" class="btn btn-outline-secondary btn-sm me-2 arrow-btn" onclick="prevDays()" aria-label="Dias anteriores">
                        <i class="bi bi-arrow-left"></i>
                    </button>

                    <div id="daySelector" class="day-selector flex-grow-1 d-flex mx-1" tabindex="0" role="listbox" aria-label="Dias disponíveis"></div>

                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2 arrow-btn" onclick="nextDays()" aria-label="Próximos dias">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>

                <input asp-for="SelectedDate" type="hidden" id="dateInput" required>
            </div>
        </div>
    </div>

    <input asp-for="SelectedTime" type="hidden" id="timeInput" />

    <div id="available-times" class="available-times schedule-grid mt-3"></div>
    <div class="col-12">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmationModal">
            Confirmar Agendamento
        </button>        
        <a class="btn btn-secondary" href="@Url.Action("Read", "Service")">Cancelar</a>
    </div>
    
    @Html.ValidationSummary(false, "", new { @class = "text-danger" })

    <div class="modal fade" id="confirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="staticBackdropLabel">Confirmar Agendamento</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <h4>Serviço</h4>
                        <p>Serviço: <span id="modalServiceName">@Model.Service.Name</span></p>
                        <p>Profissional: <span id="modalProfessional"></span></p>
                        <p>Preço: <span id="modalPrice">@Model.Service.Price</span></p>
                        <p>Data: <span id="modalDate"></span></p>
                        <p>Horário de Início: <span id="modalStartTime"></span></p>

                        <h4 class="mt-3">Cliente</h4>
                        <p>Nome: <span id="modalClientName"></span></p>
                        <p>Telefone: <span id="modalClientPhone"></span></p>

                        <div id="modalAlert" class="text-danger small mt-2" style="display:none;">
                            preencha todas as informações antes de confirmar.
                        </div>
                    </div>                
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button id="modalSubmitBtn" type="submit" class="btn btn-primary">Agendar</button>
                    </div>
            </div>
        </div>
    </div>
</form>

<div id="limitToast" class="alert alert-info position-fixed bottom-0 end-0 m-3 fade" role="alert" style="z-index: -1;" aria-live="polite">
    Você chegou ao limite máximo de agendamento (3 meses à frente).
</div>
<div id="invalidInformations" class="alert alert-danger position-fixed bottom-0 end-0 m-3 fade" role="alert" style="z-index: -1;" aria-live="assertive">
    Preencha todas as informações corretamente
</div>

@section Scripts {
    <script>
        (() => {
            'use strict';

            const forms = document.querySelectorAll('.needs-validation');

            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {

                    const nameInput = document.getElementById('inputName');
                    const name = nameInput.value.trim();
                    const parts = name.split(/\s+/);
                    const isFullName = parts.length >= 2 && parts.every(p => p.length > 1);
                    const phoneInput = document.getElementById('inputPhoneNumber');
                    const phoneDigits = phoneInput.value.replace(/\D/g, '');
                    const isValidPhone = phoneDigits.length === 11;

                    if (!isValidPhone) {
                        phoneInput.classList.add('is-invalid');
                        event.preventDefault();
                        event.stopPropagation();
                        closeModal();
                    } else {
                        phoneInput.classList.remove('is-invalid');
                    }

                    if (!isFullName) {
                        nameInput.classList.add('is-invalid');
                        event.preventDefault();
                        event.stopPropagation();
                        closeModal();
                    } else {
                        nameInput.classList.remove('is-invalid');
                    }

                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        showInvalidInformationAlert();
                    }

                    form.classList.add('was-validated');
                }, false);
            });
        })();

        const phoneInput = document.getElementById('inputPhoneNumber');
        phoneInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);

            if (value.length > 2 && value.length <= 7) {
                value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
            } else if (value.length > 7 && value.length <= 11) {
                value = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}-${value.slice(7)}`;
            } else if (value.length > 0 && value.length <= 2) {
                value = `(${value}`;
            }

            e.target.value = value;
        });

        const form = document.querySelector('form');
        form.addEventListener('submit', function () {
            const input = document.getElementById('inputPhoneNumber');
            input.value = input.value.replace(/\D/g, '');
        });

        function parseISODateToLocal(iso) {
            if (!iso) return null;
            const parts = iso.split('-').map(Number);
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        async function fetchAvailableTimes() {
            const employeeSelect = document.getElementById("inputEmployee");
            const dateInput = document.getElementById("dateInput");
            const scheduleGrid = document.getElementById("available-times");
            const serviceDurarion = document.getElementById("serviceDuration").value;

            const employeeId = employeeSelect.value;
            const date = dateInput.value;

            if (!employeeId) {
                scheduleGrid.innerHTML = "<p>Selecione um profissional.</p>"
                return;
            }

            if (!date) {
                scheduleGrid.innerHTML = "<p>Selecione uma data.</p>"
                return;
            }

            scheduleGrid.innerHTML = "<p>Carregando horários...</p>";

            try {
                const response = await fetch(`@Url.Action("GetAvailableTimes", "Appointment")?employeeId=${employeeId}&date=${date}&serviceDuration=${serviceDuration}`);
                if (!response.ok) throw new Error("Erro ao buscar horários");

                const times = await response.json();

                if (!times || times.length === 0) {
                    scheduleGrid.innerHTML = "<p>Nenhum horário disponível neste dia. Tente selecionar outro dia ou profissional</p>";
                    return;
                }

                const localDate = parseISODateToLocal(date);
                const now = new Date();

                let html = `
                    <div class="day-block text-center">
                        <h5 class="fw-semibold text-primary mb-3">Horarios disponiveis para o dia: ${localDate.toLocaleDateString('pt-BR')}</h5>
                        <label class="form-label h5 mb-3 text-center">Selecione o horario que deseja iniciar o seriviço</label>
                        <div class="d-flex flex-wrap justify-content-center">
                `;

                times.forEach(time => {
                    const [hours, minutes] = time.split(':').map(Number);
                    const [y, m, d] = date.split('-').map(Number);
                    const slotDate = new Date(y, m - 1, d, hours, minutes, 0, 0);

                    const isToday = new Date(y, m - 1, d).toDateString() === now.toDateString();
                    const hasPassed = isToday && slotDate < now;

                    html += `
                        <button type="button"
                            class="btn btn-outline-primary hour-btn ${hasPassed ? 'disabled' : ''}"
                            data-date="${date}"
                            data-time="${time}"
                            ${hasPassed ? 'disabled' : ''}>
                            ${time}
                        </button>`;
                });

                html += `</div></div>`;
                scheduleGrid.innerHTML = html;

                const hourButtons = document.querySelectorAll(".hour-btn");
                hourButtons.forEach(btn => {
                    btn.addEventListener("click", () => {
                        if (btn.classList.contains("disabled")) return;

                        hourButtons.forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");

                        const timeInput = document.getElementById('timeInput');
                        const time = btn.getAttribute('data-time') || '';

                        if (timeInput) timeInput.value = time ? `${time}:00` : '';
                    });
                });

            } catch (err) {
                console.error(err);
                scheduleGrid.innerHTML = "<p>Erro ao carregar horários.</p>";
            }
        }

        (function () {
            const confirmationModalEl = document.getElementById('confirmationModal');
            const modalSubmitBtn = document.getElementById('modalSubmitBtn');
            const modalAlert = document.getElementById('modalAlert');
            const timeInput = document.getElementById('timeInput');

            if (confirmationModalEl) {
                confirmationModalEl.addEventListener('show.bs.modal', function (event) {
                    const employeeSelect = document.getElementById('inputEmployee');
                    const professionalText = employeeSelect && employeeSelect.options.length > 0
                        ? employeeSelect.options[employeeSelect.selectedIndex].text
                        : '';
                    document.getElementById('modalProfessional').innerText = professionalText || '—';

                    const dateIso = document.getElementById('dateInput').value;
                    const selectedTime = document.querySelector('.hour-btn.active')?.getAttribute('data-time') || '';
                    document.getElementById('modalDate').innerText = dateIso ? parseISODateToLocal(dateIso).toLocaleDateString('pt-BR') : '—';
                    document.getElementById('modalStartTime').innerText = selectedTime || '—';

                    var clientName = document.getElementById('inputName').value || '—';
                    var clintPhoneNumber = document.getElementById('inputPhoneNumber').value || '—';
                    document.getElementById('modalClientName').innerText = clientName;
                    document.getElementById('modalClientPhone').innerText = clintPhoneNumber

                    timeInput.value = selectedTime || '';

                    if (!selectedTime) {
                        modalSubmitBtn.disabled = true;
                        modalAlert.style.display = 'block';
                    } else {
                        modalSubmitBtn.disabled = false;
                        modalAlert.style.display = 'none';
                    }
                });
            }
        })();

        let currentDayOffset = 0;
        let DAYS_PER_PAGE = window.innerWidth < 768 ? 4 : 7;
        const MAX_DAYS_AHEAD = 90;

        function updateMonthLabel(offset) {
            const monthContainer = document.querySelector(".month");
            const referenceDate = new Date();
            referenceDate.setDate(referenceDate.getDate() + offset);
            referenceDate.setHours(0, 0, 0, 0);
            const monthName = referenceDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            monthContainer.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        }

        function generateAvailableDays(daysToShow = DAYS_PER_PAGE, offset = 0) {
            const daySelector = document.getElementById('daySelector');
            if (!daySelector) return;

            const baseDate = new Date();
            baseDate.setHours(0, 0, 0, 0);
            baseDate.setDate(baseDate.getDate() + offset);

            let html = "";
            for (let i = 0; i < daysToShow; i++) {
                const date = new Date(baseDate);
                date.setDate(baseDate.getDate() + i);

                const isoDate = date.toLocaleDateString('en-CA');
                const label = date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit' });

                html += `
                    <button type="button" class="btn btn-outline-secondary mx-1" data-date="${isoDate}" role="option">
                        ${label}
                    </button>`;
            }

            daySelector.innerHTML = html;
            updateMonthLabel(offset);

            const buttons = daySelector.querySelectorAll("button");
            buttons.forEach(btn => {
                btn.addEventListener("click", () => {
                    buttons.forEach(b => {
                        b.classList.remove("btn-primary", "text-white");
                        b.classList.add("btn-outline-secondary");
                        b.setAttribute("aria-selected", "false");
                    });
                    btn.classList.remove("btn-outline-secondary");
                    btn.classList.add("btn-primary", "text-white");
                    btn.setAttribute("aria-selected", "true");

                    dateInput.value = btn.getAttribute("data-date");
                    fetchAvailableTimes();
                });
            });

            if (buttons.length > 0) {
                buttons[0].classList.remove("btn-outline-secondary");
                buttons[0].classList.add("btn-primary", "text-white");
                buttons[0].setAttribute("aria-selected", "true");
                dateInput.value = buttons[0].getAttribute("data-date");
            }
        }

        function nextDays() {
            if (currentDayOffset + DAYS_PER_PAGE > MAX_DAYS_AHEAD) {
                showLimitToast();
                return;
            }
            currentDayOffset += DAYS_PER_PAGE;
            generateAvailableDays(DAYS_PER_PAGE, currentDayOffset);
        }

        function prevDays() {
            if (currentDayOffset === 0) return;
            currentDayOffset -= DAYS_PER_PAGE;
            generateAvailableDays(DAYS_PER_PAGE, currentDayOffset);
        }

        function showLimitToast() {
            const toast = document.getElementById("limitToast");
            toast.classList.add("show");
            toast.style.zIndex = "9999";
            setTimeout(() => {
                toast.classList.remove("show");
                toast.style.zIndex = "-1";
            }, 3000);
        }

        function showInvalidInformationAlert() {
            const InvalidInformationAlert = document.getElementById("invalidInformations");
            InvalidInformationAlert.classList.add("show");
            InvalidInformationAlert.style.zIndex = "9999";
            setTimeout(() => {
                InvalidInformationAlert.classList.remove("show");
                InvalidInformationAlert.style.zIndex = "-1";
            }, 5000);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const employeeSelect = document.getElementById("inputEmployee");
            const dateInput = document.getElementById("dateInput");

            generateAvailableDays(DAYS_PER_PAGE, 0);
            updateMonthLabel(0);

            employeeSelect.addEventListener("change", fetchAvailableTimes);
            dateInput.addEventListener("change", fetchAvailableTimes);

            window.addEventListener("resize", () => {
                const newDays = window.innerWidth < 768 ? 4 : 7;
                if (newDays !== DAYS_PER_PAGE) {
                    DAYS_PER_PAGE = newDays;
                    generateAvailableDays(DAYS_PER_PAGE, currentDayOffset);
                }
            });

            const daySelector = document.getElementById('daySelector');
            daySelector.addEventListener('keydown', (e) => {
                const active = daySelector.querySelector('[aria-selected="true"]');
                if (!active) return;
                if (e.key === 'ArrowLeft') {
                    const prev = active.previousElementSibling;
                    if (prev) prev.click();
                    else prevDays();
                } else if (e.key === 'ArrowRight') {
                    const next = active.nextElementSibling;
                    if (next) next.click();
                    else nextDays();
                }
            });
        });

        function closeModal(){
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmationModal'));
            modal.hide();
        }

    </script>
    <style>
         :root{
            --primary:#0d6efd;
            --muted:#6c757d;
            --bg:#ffffff;
            --surface:#f8f9fa;
            --radius:10px;
        }

        .hour-btn{
            min-width:70px;
            margin:0.25rem;
            font-size:0.9rem;
            transition:all 0.15s ease-in-out;
        }

        .hour-btn.btn-outline-primary:hover:not(.active):not(:disabled){
            background-color:#e9ecef;
            color:var(--primary);
        }

        .hour-btn.active{
            background-color:var(--primary) !important;
            color:#fff !important;
            border-color:var(--primary) !important;
        }

        .hour-btn.disabled,
        .hour-btn:disabled{
            pointer-events:none;
            opacity:0.6;
        }

        .days{
            width:100%;
            display:flex;
            flex-wrap:nowrap;
            align-items:center;
            gap:0.5rem;
            background:linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.01) 100%);
            padding:0.25rem;
            border-radius:calc(var(--radius) - 4px);
        }

        .arrow-btn{
            flex:0 0 auto;
            min-width:44px;
            height:44px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            border-radius:8px;
            background:var(--surface);
        }

        .day-selector{
            display:flex;
            flex-wrap:nowrap;
            justify-content:center;
            width:100%;
            overflow-x:auto;
            -webkit-overflow-scrolling:touch;
            scroll-behavior:smooth;
            gap:0.5rem;
            padding:0.25rem 0.5rem;
            flex:1 1 auto;
            min-width:0;
            scrollbar-width:thin;
            scrollbar-color:rgba(0,0,0,0.12) transparent;
            background:transparent;
        }

        .day-selector button{
            flex:0 0 auto;
            white-space:nowrap;
            min-width:64px;
            height:56px;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:10px;
            padding:0.35rem 0.65rem;
            font-weight:600;
            color:var(--muted);
        }

        .day-selector button.btn-primary{
            box-shadow:0 6px 18px rgba(13,110,253,0.12);
            transform:translateY(-2px);
            color:#fff;
        }

        #monthLabel{
            font-size:1rem;
            color:var(--muted);
        }

        .day-selector::-webkit-scrollbar{
            height:8px;
        }
        .day-selector::-webkit-scrollbar-thumb{
            background:rgba(0,0,0,0.12);
            border-radius:4px;
        }

        @@media (max-width: 992px){
            .day-selector button{min-width:56px;height:52px;font-size:0.95rem}
            .arrow-btn{min-width:40px;height:40px}
        }

        @@media (max-width: 768px){
            .day-selector{justify-content:flex-start;padding:0 0.5rem}
            .day-selector button{min-width:52px;height:48px;font-size:0.9rem;padding:0.25rem 0.5rem}
            .month{display:none}
        }

        @@media (max-width: 576px){
            .day-selector button{min-width:48px;height:44px;font-size:0.86rem;padding:0.2rem 0.4rem}
            .days{gap:0.25rem;padding:0.15rem}
        }

        .btn:focus{outline:3px solid rgba(13,110,253,0.12);outline-offset:2px}
    </style>
}