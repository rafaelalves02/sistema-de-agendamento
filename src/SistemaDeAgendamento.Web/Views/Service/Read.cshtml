@using System.Security.Claims
@using Microsoft.Extensions.Options
@inject IOptions<BrandingOptions> BrandingOptions
@model SistemaDeAgendamento.Web.Models.Service.ReadViewModel;

@{
    ViewData["Title"] = "Serviços";
    var branding = BrandingOptions.Value;
}

@if (Model.ShowWelCome == true)
{
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold mb-3">
            Seja Bem-Vindo
        </h1>
        @if (@User.FindFirst(ClaimTypes.NameIdentifier)?.Value != null)
        {
            <h2 class="h4 text-muted">@User.FindFirst(ClaimTypes.NameIdentifier)?.Value</h2>
        }
        else
        {
            <h2 class="h4 text-muted">ao @branding.BusinessName</h2>
        }
    </div>
}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <h2 class="h3 fw-bold mb-0">
        <span class="d-none d-sm-inline">Escolha um serviço para agendar</span>
        <span class="d-sm-none">Serviços</span>
    </h2>
    @if (@User.IsInRole("Admin"))
    {
        <a class="btn btn-primary w-100 w-md-auto" asp-controller="Service" asp-action="Create">
            <i class="bi bi-plus-circle me-1"></i>Novo Serviço
        </a>
    }
</div>


@if (Model.Services == null || Model.Services.Count == 0)
{
    <div class="empty-state">
        <i class="bi bi-briefcase"></i>
        <h3 class="h5 mt-3 mb-2">Nenhum serviço cadastrado</h3>
        <p class="text-muted mb-0">Comece adicionando seu primeiro serviço.</p>
        @if (@User.IsInRole("Admin"))
        {
            <a class="btn btn-primary mt-3" asp-controller="Service" asp-action="Create">
                <i class="bi bi-plus-circle me-1"></i>Adicionar Serviço
            </a>
        }
    </div>
}
else if (@User.IsInRole("Admin"))
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th scope="col" class="ps-4">Nome</th>
                            <th scope="col">Preço</th>
                            <th scope="col">Duração</th>
                            <th scope="col" class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var service in Model.Services)
                        {
                            var totalMinutes = service.DurationInMinutes;
                            var hours = totalMinutes / 60;
                            var minutes = totalMinutes % 60;

                            string formattedDuration;
                            if (hours == 0)
                            {
                                formattedDuration = $"{minutes}min";
                            }
                            else if (minutes == 0)
                            {
                                formattedDuration = $"{hours}h";
                            }
                            else
                            {
                                formattedDuration = $"{hours}h {minutes}min";
                            }

                            <tr>
                                <td class="ps-4 fw-semibold">@service.Name</td>
                                <td>
                                    <span class="badge bg-success-subtle text-success">
                                        <i class="bi bi-currency-dollar me-1"></i>@service.Price.ToString("C")
                                    </span>
                                </td>
                                <td>
                                    <span class="text-muted">
                                        <i class="bi bi-clock me-1"></i>@formattedDuration
                                    </span>
                                </td>
                                <td class="text-end pe-4">
                                    <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Edit", "Service", new { id = service.Id })">
                                        <i class="bi bi-pencil me-1"></i>Editar
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="services-list">
        @foreach (var service in Model.Services)
        {
            var totalMinutes = service.DurationInMinutes;
            var hours = totalMinutes / 60;
            var minutes = totalMinutes % 60;

            string formattedDuration;
            if (hours == 0)
            {
                formattedDuration = $"{minutes}min";
            }
            else if (minutes == 0)
            {
                formattedDuration = $"{hours}h";
            }
            else
            {
                formattedDuration = $"{hours}h {minutes}min";
            }

            <div class="service-item">
                <div class="service-content">
                    <div class="service-info">
                        <h3 class="service-name">@service.Name</h3>
                        <div class="service-details">
                            <span class="service-duration">
                                <i class="bi bi-clock"></i>
                                @formattedDuration
                            </span>
                            <span class="service-separator">•</span>
                            <span class="service-price">
                                @service.Price.ToString("C")
                            </span>
                        </div>
                    </div>
                    <div class="service-action">
                        <a href="@Url.Action("Create", "Appointment", new { id = service.Id })"
                           class="btn btn-primary service-btn">
                            <i class="bi bi-calendar-check me-1"></i>
                            Agendar
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}

<div id="successToast" class="alert alert-success position-fixed bottom-0 end-0 m-3 fade" role="alert" style="z-index: -1;" aria-live="polite">
    Agendamento realizado com sucesso!
</div>


@section Scripts {
    <script>
        function showToast(id) {
            const toast = document.getElementById(id);
            toast.classList.add("show");
            toast.style.zIndex = "9999";
            setTimeout(() => {
                toast.classList.remove("show");
                toast.style.zIndex = "-1";
            }, 5000);
        }

        window.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get("success") === "True") {
                showToast("successToast");
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        });
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/Service/Read.css" />
}